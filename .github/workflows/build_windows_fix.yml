name: Build Windows (With Fix #12)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # --- THE CRITICAL FIX FOR ISSUE #12 ---
      - name: Fix Cargo.toml (Apply Windows Dependencies)
        shell: powershell
        run: |
          # This overwrites the broken Cargo.toml with the fixed version containing
          # the necessary Windows dependencies (wasapi, windows, tracing)
          $content = @"
          [package]
          name = "native-module"
          version = "0.1.0"
          edition = "2021"

          [lib]
          crate-type = ["cdylib"]

          [dependencies]
          napi = { version = "2.12.2", features = ["napi4"] }
          napi-derive = "2.9.3"
          cpal = "0.15.2"
          ringbuf = "0.4"
          anyhow = "1.0"
          once_cell = "1.18.0"
          rubato = "0.16"
          rand = "0.8"
          tracing = "0.1"
          tracing-attributes = "0.1.31"
          tracing-core = "0.1.36"

          [target.'cfg(target_os = "macos")'.dependencies]
          cidre = { version = "0.11.10", features = ["ca", "cm", "av", "cat", "dispatch", "ns", "sc", "cf", "blocks", "objc"] }

          [target.'cfg(target_os = "windows")'.dependencies]
          wasapi = "0.13.0"
          windows = { version = "0.52.0", features = ["Win32_Media_Audio", "Win32_System_Com", "Win32_System_Threading"] }
          "@
          
          Set-Content -Path "native-module/Cargo.toml" -Value $content
          Write-Host "Cargo.toml has been patched with Windows dependencies."

      - name: Install Dependencies
        run: npm install

      - name: Build Windows App
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run dist

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Natively-Windows-Installer
          path: release/*.exe
